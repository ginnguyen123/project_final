        <html xmlns:th="http://www.thymeleaf.org" lang="en">
<th:block th:fragment="update-orderJs" th:inline="javascript">



    <script>

        let pageCart = {
            urls: {
                getAllCartDetail: AppBase.API_CART_DETAIL,
                getAllProducts :AppBase.API_PRODUCT
            },
            elements: {},
            loadData: {},
            commands: {},
            dialogs: {
                elements: {},
                loadData: {},
                commands: {}
            }
        }
        let locationRegion = new LocationRegion();
        let cartDetail = new CartDetail();
        let idCartDetail;
        let color;
        let sizes;
        pageCart.dialogs.elements.locationRegionIdUp = $('#locationRegionIdUp');
        pageCart.dialogs.elements.provinceUp = $('#provinceUp');
        pageCart.dialogs.elements.districtUp = $('#districtUp');
        pageCart.dialogs.elements.wardUp = $('#wardsUp');
        pageCart.dialogs.elements.productNameUp = $('.productName');

        pageCart.dialogs.elements.addressUp = $('#addressUp');

        pageCart.dialogs.loadData.getAllProvinces = () => {
            return $.ajax({
                type: 'GET',
                    url: 'https://vapi.vnappmob.com/api/province/'
            })
                .done((data) => {
                    $.each(data.results, (i, item) => {
                        let str = `<option value="${item.province_id}">${item.province_name}</option>`;
                        pageCart.dialogs.elements.provinceUp.append(str);

                    })

                    addEventChangeProvinceUp();
                    addEventChangeDistrictUp();

                })
                .fail((jqXHR) => {
                    AppBase.IziToast.showErrorAlert(AppBase.AlertMessageVi.ERROR_404);
                })
        }
        pageCart.dialogs.loadData.getAllDistrictsByProvince = (provinceId) => {
            return $.ajax({
                type: 'GET',
                url: 'https://vapi.vnappmob.com/api/province/district/' + provinceId
            })
                .done((data) => {
                    // console.log(data)
                    let dir = data.results;

                    pageCart.dialogs.elements.districtUp.empty();
                    $.each(dir, (i, item) => {
                        let str = `<option value="${item.district_id}">${item.district_name}</option>`;

                        pageCart.dialogs.elements.districtUp.append(str);

                    })


                })
                .fail((jqXHR) => {
                    AppBase.IziToast.showErrorAlert(AppBase.AlertMessageVi.ERROR_404);
                })
        }
        pageCart.dialogs.loadData.getAllWardsByDistrict = (districtId) => {
            return $.ajax({
                type: 'GET',
                url: 'https://vapi.vnappmob.com/api/province/ward/' + districtId
            })
                .done((data) => {
                    pageCart.dialogs.elements.wardUp.empty();
                    $.each(data.results, (i, item) => {
                        let str = `<option value="${item.ward_id}">${item.ward_name}</option>`;
                        pageCart.dialogs.elements.wardUp.append(str);
                    })


                })
                .fail((jqXHR) => {
                    AppBase.IziToast.showErrorAlert(AppBase.AlertMessageVi.ERROR_404);
                })
        }

        pageCart.loadData.getAllCartDetail = (id) =>{

                return $.ajax({
                    type: 'GET',
                    url: pageCart.urls.getAllCartDetail + id
                })
                    .done((data)=>{

                    })
                    .fail((jqXHR)=>{
                        console.log(jqXHR);
                    })

        }

        pageCart.loadData.getProductName = () =>{

            return $.ajax({
                type: 'GET',
                url: pageCart.urls.getAllProducts
            })
                .done((data)=>{
                    $('.productName').empty();
                    $.each(data, (i, item) => {
                        let str = `<option value="${item.id}">${item.title}</option>`;
                        $('.productName').append(str);
                    })



                })
                .fail((jqXHR)=>{
                    console.log(jqXHR);
                })

        }

        pageCart.loadData.getSize = () =>{

            return $.ajax({
                type: 'GET',
                url: pageCart.urls.getAllCartDetail +'sizes'
            })
                .done((data)=>{
                    $('.size').empty();
                    $.each(data, (i, item) => {
                        let str = `<option value="${item}">${item}</option>`;
                        $('.size').append(str);
                    })

                })
                .fail((jqXHR)=>{
                    console.log(jqXHR);
                })

        }

        pageCart.loadData.getColor = () =>{
            return $.ajax({
                type: 'GET',
                url: pageCart.urls.getAllCartDetail +'colors'
            })
                .done((data)=>{
                    $('.color').empty();
                    $.each(data, (i, item) => {
                        let str = `<option value="${item}">${item}</option>`;
                        $('.color').append(str);
                    })

                })
                .fail((jqXHR)=>{
                    console.log(jqXHR);
                })

        }

        pageCart.loadData.getCart = () => {
            /*<![CDATA[*/
            let data = /*[[${data}]]*/ 'default';
            let cart = data.cart;
            console.log(cart)
            let name_receiver = cart.name_receiver;
            let phone_receiver = cart.phone_receiver;
            let locationRegion = cart.locationRegion;
            let status = cart.status;
            let idCart = cart.id;
            let listCartDetail = cart.cartDetailDTOList;
            let totalAmount = cart.totalAmount;
            let address = cart.locationRegion.address;

            $('#nameReceiverUp').val(name_receiver);
            $('#phoneReceiverUp').val(phone_receiver);
            $('#totalAmountUp').val(totalAmount);
            $('#statusUp').val(status);
            $('#addressUp').val(address);
            pageCart.dialogs.loadData.getAllProvinces().then(() => {
                pageCart.dialogs.elements.provinceUp.val(locationRegion.provinceId)
            })
            pageCart.dialogs.loadData.getAllDistrictsByProvince(locationRegion.provinceId).then(() => {
                pageCart.dialogs.elements.districtUp.val(locationRegion.districtId)
            })
            pageCart.dialogs.loadData.getAllWardsByDistrict(locationRegion.districtId).then(() => {
                pageCart.dialogs.elements.wardUp.val(locationRegion.wardId)
            })

            $.each(listCartDetail, (i, item)=>{
                let str = AppBase.renderCartDetail(item);
                $('#tbCartDetail').append(str);
                pageCart.loadData.getProductName().then(()=>{
                    $.each(listCartDetail, (i, item)=>{
                        $(`#${item.id}`).val(item.productId)
                    })
                    addEventChangePriceUp(listCartDetail.id);
                });
                pageCart.loadData.getSize().then(()=>{
                    $.each(listCartDetail, (i, item)=>{
                        $(`#${item.size}${item.id}`).val(item.size)
                    })
                });
                pageCart.loadData.getColor().then(()=>{
                    $.each(listCartDetail, (i, item)=>{
                        $(`#${item.color}${item.id}`).val(item.color)
                    })
                });
                addEventDeleteClick();
            });
            /*]]>*/
        }

        pageCart.loadData.getCartDetail = (id,idProduct, color, size) =>{
            let objCartDetail = {
                id:id,
                idProduct:idProduct,
                size:size,
                color:color
            }
            console.log("-----------")
            console.log(objCartDetail)
            return $.ajax({
                dataType: 'json',
                contentType: 'application/json',
                type: 'POST',
                url: pageCart.urls.getAllCartDetail +'product-imp-cart-detail',
                data:JSON.stringify(objCartDetail)
            })
                .done((data)=>{
                    console.log("-----------")
                    console.log(data)
                    $.each(data, (i, item) => {
                        let str = AppBase.renderCartDetail(data)
                            $('#tr_' + item.id).replaceWith(str)

                    })

                })
                .fail((jqXHR)=>{
                    console.log(jqXHR);
                })
            // call api http://localhost:8086/api/cart-details/product-imp-cart-detail
            // => trả về data => log data ra xem
            //let str = App.renderCartDetail(data)
            // $('#tr_'idCartDetail).replacewith(str)
        }

        pageCart.loadData.checkQuantityBySizeAndColor = (idProduct) =>{
            let sizeObj = $('.size').data('id');
            let colorObj = $('.color').data('id');
            let obj={
                id:idProduct,
                size: sizeObj,
                color: colorObj
            }
            return $.ajax({
                dataType: 'json',
                contentType: 'application/json',
                type: 'POST',
                url: pageCart.urls.getAllCartDetail + 'size_color',
                data: JSON.stringify(obj)
            })
                .done(()=>{

                })
                .fail((error)=>{
                    console.log(error)
                })
        }

        function doUpdate(){

        }
        function addEventDeleteClick() {
            $(".delete").on('click', function () {
                let cartId = $(this).data('id');
                pageCart.loadData.findCartById(cartId).then((data) => {
                     idCartDetail = data.id;

                    AppBase.showDeleteCartItemConfirmDialog().then((result) => {
                        if (result.isConfirmed) {
                            $.ajax({
                                headers: {
                                    'accept': 'application/json',
                                    'content-type': 'application/json'
                                },
                                type: "DELETE",
                                url: pageCart.urls.getAllCartDetail + "" + idCartDetail
                            })
                                .done(() => {
                                    $("#tr_" + idCartDetail).remove();
                                    AppBase.IziToast.showSuccessAlert(AppBase.AlertMessageVi.SUCCESS_DELETED);
                                })
                                .fail((error) => {
                                    AppBase.IziToast.showErrorAlert(AppBase.AlertMessageVi.ERROR_DELETED);
                                })
                        }
                    })
                })
            })

        }

        pageCart.loadData.findCartById = (id) => {
            return $.ajax({
                type: 'GET',
                url: pageCart.urls.getAllCartDetail + 'find-id-cart-detail/' + id
            })
                .done((data) => {
                    console.log(data)
                    //
                    // $('.select-search').select2({
                    //     dropdownParent: $('#tbCartDetail')
                    // });

                })
                .fail(() => {

                })
        }

        pageCart.loadData.getPrice = (idProduct) =>{
            return $.ajax({
                type: 'GET',
                url: pageCart.urls.getAllCartDetail +'price/' + idProduct
            })
                .done((price)=>{


                })
                .fail((jqXHR)=>{
                    console.log(jqXHR);
                })

        }

        function addEventChangePriceUp(id) {
            $('.productName').on("change", function () {

                pageCart.loadData.findCartById(id).then((data) => {
                    // phải tìm id của cartDetail
                    idCartDetail = data.id;
                let productId = $(this).val();
                let colorPri = $('.color').val();


                let sizePri = $('.size').val();
                // let color => lấy lại màu
                // let size => lấy lại size
                pageCart.loadData.getCartDetail(idCartDetail,productId, colorPri, sizePri)

            })
        })
        }


        function addEventChangeProvinceUp() {
            pageCart.dialogs.elements.provinceUp.on("change", function () {
                let provinceId = $(this).val();
                if (provinceId !== 0) {
                    pageCart.dialogs.loadData.getAllDistrictsByProvince(provinceId).then(() => {
                        let districtId = pageCart.dialogs.elements.districtUp.val();
                        pageCart.dialogs.loadData.getAllWardsByDistrict(districtId);
                    })
                }
            })
        }

        function addEventChangeDistrictUp() {

            pageCart.dialogs.elements.districtUp.on("change", function () {
                let districtId = $(this).val();

                if (districtId !== 0) {
                    pageCart.dialogs.loadData.getAllWardsByDistrict(districtId);
                }

            })
        }

        pageCart.commands.loadData = () => {
            pageCart.loadData.getCart();
        }
        pageCart.initializeControlEvent = () => {

            //change thay đổi sản phẩm
            // change size
            // change màu

        }
        $(() => {
            pageCart.commands.loadData();

            pageCart.initializeControlEvent();
        })
    </script>
</th:block>